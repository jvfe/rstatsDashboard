---
title: "#rstats Twitter Explorer"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: scroll
    source_code: embed
    theme: 
      version: 4
      bootswatch: yeti
    css: styles/main.css
---

```{r setup, include=FALSE}
library(flexdashboard)
library(rtweet)
library(dplyr)
library(httr)
library(lubridate)
library(echarts4r)
library(jsonlite)
library(purrr)

get_unique_value <- function(data, col) {
  col <- enquo(col)
  data %>%
    pull(!!col) %>%
    unique() %>%
    length()
}

rstats_tweets <- read_twitter_csv("data/rstats_tweets.csv")

rbloggers <- fromJSON("data/rbloggers.json")

count_timeseries <- rstats_tweets %>%
  ts_data(by = "hours")

tweets_today <- rstats_tweets %>%
  filter(created_at == today()-1)

by_hour <- rstats_tweets %>%
  group_by(hour = hour(created_at)) %>%
  summarise(count = n()) %>%
  ungroup()

number_of_unique_tweets <- get_unique_value(rstats_tweets, text)

number_of_unique_tweets_today <- get_unique_value(tweets_today, text)

number_of_tweeters_today <- get_unique_value(tweets_today, user_id)

number_of_likes <- rstats_tweets %>%
  pull(favorite_count) %>%
  sum()

get_tweet_embed <- function(user, status_id) {
  
  url <- stringr::str_glue("https://publish.twitter.com/oembed?url=https://twitter.com/{user}/status/{status_id}&partner=&hide_thread=false")

  
  response <- GET(url) %>%
    content()

  return(shiny::HTML(response$html))
}
```


Home
====

Row
-----------------------------------------------------------------------

### Tweets Today

```{r}
valueBox(number_of_unique_tweets_today, icon = "fa-comment-alt", color = "plum")
```

### Tweeters Today

```{r}
valueBox(number_of_tweeters_today, icon = "fa-user", color = "peachpuff")
```

### #rstats Likes

```{r}
valueBox(number_of_likes, icon = "fa-heart", color = "palevioletred")
```

### #rstats Tweets

```{r}
valueBox(number_of_unique_tweets, icon = "fa-comments", color = "mediumorchid")
```

Row {.tabset .tabset-fade data-width=400}
-----------------------------------------------------------------------

### Tweet volume

```{r}
count_timeseries %>%
  e_charts(time) %>%
  e_line(n, name = "# of tweets", smooth = TRUE) %>%
  e_x_axis(
    type = "time",
    formatter = htmlwidgets::JS(
      "function(value){
        let date = new Date(value);
        
        label = `${date.getDate()}-${(parseInt(date.getMonth()) + 1)}-${date.getFullYear()}`;
        return label;
      }"
    )
  ) %>%
  e_axis_labels(y = "Tweets") %>%
  e_theme("westeros") %>%
  e_tooltip(trigger = "axis", formatter = htmlwidgets::JS("
    function(params) {
      let date = new Date(params[0].value[0])
      let options = { year: 'numeric', month: 'short', day: 'numeric', hour: 'numeric'}
      let title = `<strong>${date.toLocaleDateString('en-US', options=options)}</strong>`
      let num = `${params[0].value[1]} tweets`
      return(`${title}</br>${num}`);
    }"))
```

### Tweets by Hour of Day

```{r}
by_hour %>%
  e_charts(hour) %>%
  e_step(count, name = "Tweets", step = "middle") %>%
  e_x_axis(
    min = 0,
    max = 23,
  ) %>%
  e_axis_labels(x = "Time of Day (UTC)", y = "Tweets") %>%
  e_theme("westeros") %>%
  e_tooltip(trigger = "axis", formatter = htmlwidgets::JS("
    function(params) {
      let title = `<strong>${params[0].value[0]}h</strong>`
      let num = `${params[0].value[1]} tweets`
      return(`${title}</br>${num}`);
    }"))
```

Row
-----------------------------------------------------------------------

### ðŸ’— Most Liked Tweet Today {.tweet-box}

```{r}
most_liked_url <- tweets_today %>%
  slice_max(favorite_count)

get_tweet_embed(most_liked_url$screen_name, most_liked_url$status_id)
```

### âœ¨ Most Retweeted Tweet Today {.tweet-box}

```{r}
most_retweeted <- tweets_today %>%
  slice_max(retweet_count)

get_tweet_embed(most_retweeted$screen_name, most_retweeted$status_id)
```

### ðŸŽ‰ Most Recent {.tweet-box}

```{r}
most_recent <- tweets_today %>%
  slice_max(created_at)

get_tweet_embed(most_recent$screen_name[1], most_recent$status_id[1])
```

RBloggers
=========

Row {.tabset .tabset-fade data-height=1000}
-----------------------------------------------------------------------

### Top Tweets - 7 days {.tweet-wall}

```{r}
rblog_7 <- rbloggers %>% 
  mutate(created_at = as_date(created_at)) %>% 
  filter(created_at %within% interval(start = today() - 7, end = today())) %>% 
  slice_max(favorite_count + retweet_count, n = 8)

rblog_7_html <- map2_chr(rblog_7$screen_name, rblog_7$status_id, get_tweet_embed)

shiny::HTML(stringr::str_glue("{rblog_7_html}"))
```

### Top Tweets - 30 days {.tweet-wall}

```{r}
rblog_30 <- rbloggers %>% 
  mutate(created_at = as_date(created_at)) %>% 
  filter(created_at %within% interval(start = today() - 30, end = today())) %>% 
  slice_max(favorite_count + retweet_count, n = 8)

rblog_30_html <- map2_chr(rblog_30$screen_name, rblog_30$status_id, get_tweet_embed)

shiny::HTML(stringr::str_glue("{rblog_30_html}"))
```

